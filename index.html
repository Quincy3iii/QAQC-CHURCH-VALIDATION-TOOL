<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Data QA/QC Analyst v4.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            position: relative; 
        }
        .drop-zone.drag-over {
            background-color: #e2e8f0;
            border-color: #4f46e5;
        }
        .drop-zone input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .details-marker {
            transition: transform 0.2s;
        }
        details[open] .details-marker {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

     <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <div class="mb-6 text-right">
            <a href="https://github.com/Quincy3iii/QAQC-CHURCH-VALIDATION-TOOL/blob/main/README.md" target="_blank" rel="noopener noreferrer" class="font-semibold text-indigo-600 hover:underline">
                View Instructions on GitHub ↗
            </a>
        </div>
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b">
                <h1 class="text-2xl font-bold text-slate-900">1. Upload & Audit</h1>
            </div>
            <div class="p-6">
                <div id="drop-zone" class="drop-zone rounded-lg p-8 text-center">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="w-12 h-12 text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p class="text-slate-600 font-semibold">Drag & drop your CSV file here</p>
                        <p class="text-slate-500 text-sm">or click to select a file</p>
                        <p id="file-name" class="text-indigo-600 font-medium mt-2"></p>
                    </div>
                    <input type="file" id="csvFile" accept=".csv">
                </div>
                <div id="pre-validation-step" class="mt-4" style="display: none;">
                    <label for="buildingType" class="block text-sm font-medium text-slate-700 mb-1">Select Building Type:</label>
                    <select id="buildingType" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="">-- Please select --</option>
                        <option value="Meetinghouse">Meetinghouse, Seminary, or Institute</option>
                        <option value="Welfare">Welfare, Self Reliance, or Deseret Industry Facility</option>
                    </select>
                </div>
                <div class="mt-6">
                    <button id="validate-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                        Run Internal Audit
                    </button>
                </div>
            </div>
        </div>

        <div id="results-container" class="mt-8 bg-white rounded-lg shadow-md" style="display:none;">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-900">2. Audit Report</h2>
                <div class="flex space-x-2">
                    <button id="download-csv-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" style="display: none;">
                        Download Detailed CSV
                    </button>
                    <button id="download-summary-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" style="display: none;">
                        Download Summary CSV
                    </button>
                </div>
            </div>
            <div id="report-content" class="p-6 space-y-4">
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const validationRules = { 'ACU': { description: ['Split System Indoor Unit'], capacityUnit: ['TON'] }, 'AHU': { description: ['Air Handling Unit', 'Small Capacity Air Handling Unit'], capacityUnit: ['TON'] }, 'BHW': { description: ['Gas Fired Boiler'], capacityUnit: ['BTU'] }, 'BWH': { description: ['Electric Boiler'], capacityUnit: ['BTU'] }, 'CHL': { description: ['Chiller'], capacityUnit: ['TON', 'BTU'] }, 'CTU': { description: ['Cooling Tower'], capacityUnit: [] }, 'CU': { description: ['Air Cooled Condensing Unit', 'Split System Heat Pump'], capacityUnit: ['TON'] }, 'DF': { description: ['Duct Furnace'], capacityUnit: ['BTU'] }, 'EF': { description: ['Electric Furnace'], capacityUnit: ['BTU'] }, 'ERV': { description: ['Energy Recovery Ventilator (ERV)'], capacityUnit: ['CFM'] }, 'F': { description: ['Gas Fired Furnace', 'Hydronic Furnace'], capacityUnit: ['BTU'] }, 'RTU': { description: ['Roof Top Unit', 'Air Conditioning Package Unit'], capacityUnit: ['TON'] }, 'WAC': { description: ['Wall Mounted AC'], capacityUnit: ['TON', 'BTU'] }, 'WSHP': { description: ['Water Source Heat Pump'], capacityUnit: ['TON'] }, 'ASR': { description: ['Asphalt Shingle Roof'], capacityUnit: ['Sq.Ft.'] }, 'BUA': { description: ['Built Up Asphalt/Bitumen Roof'], capacityUnit: ['Sq.Ft.'] }, 'CTR': { description: ['Concrete Tile Roof'], capacityUnit: ['Sq.Ft.'] }, 'MSR': { description: ['Metal Roof'], capacityUnit: ['Sq.Ft.'] }, 'PVC': { description: ['PVC Roof'], capacityUnit: ['Sq.Ft.'] }, 'SPM': { description: ['Single Ply Membrane Roof'], capacityUnit: ['Sq.Ft.'] }, 'SSM': { description: ['Standing-Seam Metal Roof'], capacityUnit: ['Sq.Ft.'] }, 'PLA': { description: ['Asphalt Parking Lot'], capacityUnit: ['Sq.Ft.'] }, 'PLC': { description: ['Concrete Parking Lot'], capacityUnit: ['Sq.Ft.'] }, 'PLD': { description: ['Dirt Parking Lot'], capacityUnit: ['Sq.Ft.'] }, 'PLG': { description: ['Gravel Parking Lot'], capacityUnit: ['Sq.Ft.'] }, 'SS': { description: ['Low Voltage Sound System'], capacityUnit: [] }, 'FLC': { description: ['Carpet Flooring'], capacityUnit: ['Sq.Ft.'] }, 'FLT': { description: ['Tile Flooring'], capacityUnit: ['Sq.Ft.'] }, 'FLV': { description: ['Vinyl Flooring'], capacityUnit: ['Sq.Ft.'] }, 'FLCON': { description: ['Concrete Flooring'], capacityUnit: ['Sq.Ft.'] }, 'FLW': { description: ['Wood Flooring'], capacityUnit: ['Sq.Ft.'] }, 'FACP': { description: ['Fire Alarm Control Panel'], capacityUnit: ['AMP', 'AMPS', ''] }, 'FSSD': { description: ['Fire Riser (Dry)'], capacityUnit: ['GPM', ''] }, 'FSSW': { description: ['Fire Riser (Wet)', 'Deluge Fire Suppression System (Wet)'], capacityUnit: ['GPM', ''] }, 'FSSC': { description: ['FM-200 Fire Suppression System (Chemical)'], capacityUnit: ['Other (List in Comments)'] }, 'DOCK': { description: ['Dock Plate'], capacityUnit: ['TON'] }, 'RUD': { description: ['Automatic Rollup Door'], capacityUnit: [] }, 'EASD': { description: ['Sliding Automatic or Manual Entrances Exterior (Storehouse Only)'], capacityUnit: [] }, 'ESD': { description: ['Swinging Automatic or Manual Entrances Exterior (Storehouse Only)'], capacityUnit: [] }, 'IASD': { description: ['Sliding Automatic or Manual Entrances Interior (Storehouse Only)'], capacityUnit: [] }, 'ISD': { description: ['Swinging Automatic or Manual Entrances Interior (Storehouse Only)'], capacityUnit: [] }, 'RD': { description: ['Revolving Door Entrances (Storehouse Only)'], capacityUnit: [] }, 'COOL': { description: ['Reach-In Display Cooler (Storehouse Only)', 'Walk-In Cooler (Storehouse Only)'], capacityUnit: ['BTU'] }, 'FRZ': { description: ['Reach-In Display Freezer (Storehouse Only)', 'Walk-In Freezer (Storehouse Only)'], capacityUnit: ['BTU'] }, 'FRK': { description: ['Forklift Truck - Electric', 'Forklift Truck - Diesel'], capacityUnit: ['Other (List In Comments)'] }, 'FLB': { description: ['Forklift Battery'], capacityUnit: ['V'] }, 'UH': { description: ['Gas Fired Unit Heater', 'Electric Unit Heater'], capacityUnit: ['BTU'] }, 'DRY': { description: ['Clothes Dryer (Storehouse Only)'], capacityUnit: [] }, 'WSH': { description: ['Washing Machine (Storehouse Only)'], capacityUnit: [] }, 'WDC': { description: ['Washer/Dryer Combo (Storehouse Only)'], capacityUnit: [] }, 'FWC': { description: ['Compactor (Storehouse Only)'], capacityUnit: [] }, 'FWB': { description: ['Baler (Storehouse Only)'], capacityUnit: [] },};
    const refrigerantDateRules = {
	    'R-22': {
	        phaseOutDate: new Date('2010-01-01'), 
	        reason: (date) => `R-22 was phased out for new equipment in 2010, but the in-service date is ${date}.`
	    },
	    'R-12': {
	        phaseOutDate: new Date('1996-01-01'), 
	        reason: (date) => `R-12 was banned for new equipment in 1996, but the in-service date is ${date}.`
	    },
	    'R-410A': {
	        phaseOutDate: new Date('2024-01-01'), 
	        reason: (date) => `R-410A is being phased down; an in-service date of ${date} is unlikely for this refrigerant.`
	    },
		'R-134a': {
			phaseOutDate: new Date('2025-01-01'),
			reason: (date) => `R-134a is being phased down; an in-service date of ${date} is unlikely for this refrigerant.`
		}
	};
	const assetEUL = {
		'ACU': 18, 'AHU': 25, 'BHW': 25, 'BWH': 22, 'CHL': 25, 'CTU': 20, 'CU':  15, 'DF':  20, 'EF':  18, 'ERV': 20, 'F':   18, 'RTU': 18, 'UH':  20, 'WAC': 12, 'WSHP': 20,
		'ASR': 20, 'BUA': 20, 'CTR': 50, 'MSR': 40, 'PVC': 20, 'SPM': 20, 'SSM': 40, 'PLA': 20, 'PLC': 30,
		'FLC': 10, 'FLT': 40, 'FLV': 20, 'FLCON': 60, 'FLW': 40,
		'FACP': 15, 'FSSD': 40, 'FSSW': 40, 'FSSC': 25, 'SS': 12,
		'DOCK': 15, 'RUD': 20, 'EASD': 12, 'ESD': 12, 'IASD': 12, 'ISD': 12, 'RD': 15, 'COOL': 15, 'FRZ': 15, 'FRK': 10, 'FLB': 5, 'DRY': 12, 'WSH': 12, 'WDC': 12, 'FWC': 15, 'FWB': 15
	};
	const welfareOnlyAcronyms = new Set(['DOCK', 'RUD', 'EASD', 'ESD', 'IASD', 'ISD', 'RD', 'COOL', 'FRZ', 'FRK', 'FLB', 'UH', 'DRY', 'WSH', 'WDC', 'FWC', 'FWB']);
    const requiredWelfareAcronyms = {
    'Roof System': ['ASR', 'BUA', 'CTR', 'MSR', 'PVC', 'SPM', 'SSM'],
    'Parking Lot': ['PLA', 'PLC', 'PLD', 'PLG'],
    'Storefront Doors': ['EASD', 'ESD', 'RD'],
    'Rollup Door': 'RUD',
    'Dock Plate': 'DOCK',
    'Fire Alarm Panel': 'FACP',
    'Fire Suppression System': ['FSSD', 'FSSW', 'FSSC'],
    'Forklift': 'FRK',
    'Forklift Battery': 'FLB',
    'Cooler/Freezer System': ['COOL', 'FRZ'],
    'Laundry System': ['WSH', 'DRY', 'WDC'],
    'Compactor': 'FWC',
    'Baler': 'FWB'
	};
	const refrigerantNotRequiredAssets = new Set(['Wood Flooring', 'Washing Machine (Storehouse Only)', 'Washer/Dryer Combo (Storehouse Only)', 'Vinyl Flooring', 'Tile Flooring', 'Swinging Automatic or Manual Entrances Interior (Storehouse Only)', 'Swinging Automatic or Manual Entrances Exterior (Storehouse Only)', 'Standing-Seam Metal Roof', 'Sliding Automatic or Manual Entrances Interior (Storehouse Only)', 'Sliding Automatic or Manual Entrances Exterior (Storehouse Only)', 'Single Ply Membrane Roof', 'Revolving Door Entrances (Storehouse Only)', 'PVC Roof', 'Metal Roof', 'Low Voltage Sound System', 'Gravel Parking Lot', 'Gas Fired Unit Heater', 'Gas Fired Furnace', 'Furnace', 'Hydronic Furnace', 'Gas Fired Boiler', 'Fire Suppression Hood', 'FM-200 Fire Suppression System (Chemical)', 'Forklift Battery', 'Fire Riser (Dry)', 'Fire Riser (Wet)', 'Electric Unit Heater', 'Electric Furnace', 'Dock Plate', 'Dirt Parking Lot', 'Deluge Fire Suppression System (Wet)', 'Concrete Tile Roof', 'Concrete Parking Lot', 'Compactor (Storehouse Only)', 'Clothes Dryer (Storehouse Only)', 'Carpet Flooring', 'Built Up Asphalt/Bitumen Roof', 'Baler (Storehouse Only)', 'Automatic Rollup Door', 'Asphalt Shingle Roof', 'Asphalt Parking Lot', 'Fire Alarm Control Panel']);
    const splitSystemIndoor = new Set(['ACU', 'AHU', 'CHL', 'F', 'WSHP']);
    const splitSystemOutdoor = new Set(['CTU', 'CU']);
    const refrigerantKeywords = [  'R-11', 'R-12', 'R-12B1', 'R-13', 'R-13B1', 'R-13I1', 'R-14', 'R-21', 'R-22', 'R-23', 'R-30', 'R-31', 'R-32', 'R-40', 'R-41', 'R-50', 'R-113', 'R-114', 'R-115', 'R-116', 'R-123', 'R-124', 'R-125', 'R-134a', 'R-141b', 'R-142b', 'R-143a', 'R-152a', 'R-170', 'R-E170', 'R-218', 'R-227ea', 'R-236fa', 'R-245fa', 'R-290', 'R-C318', 'R-600', 'R-600a', 'R-601', 'R-601a', 'R-610', 'R-611', 'R-630', 'R-631', 'R-702', 'R-704', 'R-717', 'R-718', 'R-720', 'R-728', 'R-732', 'R-740', 'R-744', 'R-744A', 'R-764', 'R-1130(E)', 'R-1132a', 'R-1132(E)', 'R-1150', 'R-1224yd(Z)', 'R-1233zd(E)', 'R-1234yf', 'R-1234ze(E)', 'R-1270', 'R-1336mzz(E)', 'R-1336mzz(Z)', 'R-400', 'R-401A', 'R-401B', 'R-401C', 'R-402A', 'R-402B', 'R-403A', 'R-403B', 'R-404A', 'R-405A', 'R-406A', 'R-407A', 'R-407B', 'R-407C', 'R-407D', 'R-407E', 'R-407F', 'R-407G', 'R-407H', 'R-407I', 'R-408A', 'R-409A', 'R-409B', 'R-410A', 'R-410B', 'R-411A', 'R-411B', 'R-412A', 'R-413A', 'R-414A', 'R-414B', 'R-415A', 'R-415B', 'R-416A', 'R-417A', 'R-417B', 'R-417C', 'R-418A', 'R-419A', 'R-419B', 'R-420A', 'R-421A', 'R-421B', 'R-422A', 'R-422B', 'R-422C', 'R-422D', 'R-422E', 'R-423A', 'R-424A', 'R-425A', 'R-426A', 'R-427A', 'R-427B', 'R-427C', 'R-428A', 'R-429A', 'R-430A', 'R-431A', 'R-432A', 'R-433A', 'R-433B', 'R-433C', 'R-434A', 'R-435A', 'R-436A', 'R-436B', 'R-436C', 'R-437A', 'R-438A', 'R-439A', 'R-440A', 'R-441A', 'R-442A', 'R-443A', 'R-444A', 'R-444B', 'R-445A', 'R-446A', 'R-447A', 'R-447B', 'R-448A', 'R-448B', 'R-449A', 'R-449B', 'R-449C', 'R-450A', 'R-451A', 'R-451B', 'R-452A', 'R-454B', 'R-454C', 'R-455A', 'R-456A', 'R-457A', 'R-458A', 'R-459A', 'R-459B', 'R-460A', 'R-460B', 'R-460C', 'R-461A', 'R-462A', 'R-463A', 'R-464A', 'R-465A', 'R-500', 'R-501', 'R-502', 'R-503', 'R-504', 'R-505', 'R-506', 'R-507A', 'R-508A', 'R-508B', 'R-509A', 'R-510A', 'R-511A', 'R-512A', 'R-513A', 'R-513B', 'R-514A', 'R-515A', 'R-516A', 'Other (List in Comments)'];
    const refrigerantKeywordsSet = new Set(refrigerantKeywords.map(keyword => keyword.toUpperCase()));
	const requiredMeetinghouseAcronyms = { 'Sound System (SS)': 'SS', 'Fire Alarm Panel (FACP)': 'FACP', 'Fire Suppression System': ['FSSD', 'FSSW', 'FSSC'], 'Roof System': ['ASR', 'BUA', 'CTR', 'MSR', 'PVC', 'SPM', 'SSM'], 'Parking Lot': ['PLA', 'PLC', 'PLD', 'PLG'], 'Flooring (Building Envelope)': ['FLC'], 'Flooring (Cultural Center)': ['FLC', 'FLV', 'FLW'] };
	const capacityExemptAcronyms = new Set(['FSSW', 'FSSD', 'SS', 'FACP']);
	const areaServedSynonyms = {
        'Place of Worship': ['chapel', 'worship center', 'meeting hall'],
        'Cultural Center': ['cultural hall', 'multipurpose', 'cc'],
        'Building Envelope': ['whole building']
    };
	const assetsRequiringParent = new Set(['DF', 'FLB']);
	const selfContainedAHUKeywords = new Set(['package', 'make up air unit', 'roof top']);
	
    function getAcronym(assetNumber) {
        if (!assetNumber) return '';
        return (assetNumber.split('-')[0] || '').trim();
    }

    function validateRow(row, buildingType, zoneData) {
        const errors = [];
        const assetNumber = row['att_Asset #'] || '';
		        if (assetNumber && !assetNumber.startsWith('TEMPLATE') && !/^[A-Z]{1,5}-\d/.test(assetNumber)) {
            errors.push({ 
                field: 'att_Asset #', 
                value: assetNumber, 
                reason: 'Asset # format is invalid. It must consist of an acronym followed by a dash and a number (e.g., FACP-1).', 
                category: 'Formatting & Syntax Errors' 
            });
        }
        const assetDescription = row['att_Asset Description'] || '';
        const capacityUnit = row['att_Capacity Unit'];
        const assetAcronym = getAcronym(assetNumber);
        const rule = validationRules[assetAcronym];
        const isTagOnPM = (row['Reason Not Tagged'] || '').trim().toLowerCase() === 'tag on pm (put reason in comments)';
        const isNotFoundPlaceholder = (row['Reason Not Tagged'] || '').trim() === 'Not Found' && !row['TagID'];

        if (assetNumber.startsWith('TEMPLATE') && row['TagID'] !== 'DELETE') {
            errors.push({ field: 'TagID', value: row['TagID'], reason: 'Template asset must be marked for deletion with TagID = "DELETE".', category: 'Template Rows to Delete' });
            return errors;
        }

        if (row['TagID'] === 'DELETE') {
            if (row['att_Space (Floor)'] !== 'Not Found') errors.push({ field: 'att_Space (Floor)', value: row['att_Space (Floor)'], reason: 'Template row floor must be "Not Found".', category: 'Template Rows to Delete' });
            if (row['att_Room'] !== 'Template') errors.push({ field: 'att_Room', value: row['att_Room'], reason: 'Template row room must be "Template".', category: 'Template Rows to Delete' });
            if (row['Status'] !== 'Offline') errors.push({ field: 'Status', value: row['Status'], reason: 'Template row status must be "Offline".', category: 'Template Rows to Delete' });
            return errors;
        }

        if (isNotFoundPlaceholder) {
            if (row['att_Space (Floor)'] !== 'Not Found') errors.push({ field: 'att_Space (Floor)', value: row['att_Space (Floor)'], reason: 'Floor must be "Not Found".', category: 'Missing Required Data' });
            if (row['att_Room'] !== 'Not Found') errors.push({ field: 'att_Room', value: row['att_Room'], reason: 'Room must be "Not Found".', category: 'Missing Required Data' });
            if (!row['att_Areas Served']) errors.push({ field: 'att_Areas Served', value: row['att_Areas Served'], reason: 'Areas Served cannot be blank.', category: 'Missing Required Data' });
            const noNameplate = "No Nameplate Information Available";
            if (row['att_Manufacturer'] !== noNameplate) errors.push({ field: 'att_Manufacturer', value: row['att_Manufacturer'], reason: `Must be "${noNameplate}".`, category: 'Missing Required Data' });
            if (row['att_Model'] !== noNameplate) errors.push({ field: 'att_Model', value: row['att_Model'], reason: `Must be "${noNameplate}".`, category: 'Missing Required Data' });
            if (row['att_Serial #'] !== noNameplate) errors.push({ field: 'att_Serial #', value: row['att_Serial #'], reason: `Must be "${noNameplate}".`, category: 'Missing Required Data' });
            let expectedComment = '';
            let reasonText = '';
            if (assetAcronym === 'FLW') {
                expectedComment = 'no cultural center flw found';
                reasonText = '"No Cultural Center FLW found"';
            } else {
                expectedComment = `no ${assetAcronym} found`.toLowerCase();
                reasonText = `"No ${assetAcronym} found"`;
            }
            if (!(row['att_Validation Comment'] || '').toLowerCase().includes(expectedComment)) {
                errors.push({ field: 'att_Validation Comment', value: row['att_Validation Comment'], reason: `Comment must contain ${reasonText}.`, category: 'Missing Required Data' });
            }
            return errors; 
        }

        const roomName = row['att_Room'] || '';
        if (roomName) {
            const words = roomName.split(' ');
            if (words.length === 1 && /^[A-Z]?\d+$/i.test(words[0])) {
                errors.push({ field: 'att_Room', value: roomName, reason: 'Room number requires a descriptive prefix (e.g., \'Room M101\').', category: 'Formatting & Syntax Errors' });
            }
            if (words.some(w => w && w[0] !== w[0].toUpperCase())) {
                errors.push({ field: 'att_Room', value: roomName, reason: 'Improper capitalization. All words should be capitalized.', category: 'Formatting & Syntax Errors' });
            }
            const cardinalAbbreviations = /\b(N|S|E|W|NE|NW|SE|SW)\b/g;
            if (cardinalAbbreviations.test(roomName)) {
                errors.push({ field: 'att_Room', value: roomName, reason: 'Use full cardinal directions (e.g., "Southwest" instead of "SW").', category: 'Formatting & Syntax Errors' });
            }
            const compoundCardinals = {
                'south west': 'Southwest', 'south east': 'Southeast',
                'north west': 'Northwest', 'north east': 'Northeast'
            };
            const roomNameLower = roomName.toLowerCase();
            for (const [incorrect, correct] of Object.entries(compoundCardinals)) {
                if (roomNameLower.includes(incorrect)) {
                    errors.push({ 
                        field: 'att_Room', 
                        value: roomName, 
                        reason: `Use the compound word "${correct}" instead of the two-word version.`, 
                        category: 'Formatting & Syntax Errors' 
                    });
                }
            }
            const possessives = { "Bishops": "Bishop's", "Clerks": "Clerk's", "Presidents": "President's", "Mothers": "Mother's", "Members": "Member's" };
            for (const [wrong, right] of Object.entries(possessives)) {
                if (roomName.includes(wrong)) {
                     errors.push({ field: 'att_Room', value: roomName, reason: `Missing apostrophe. Should be "${right}".`, category: 'Formatting & Syntax Errors' });
                }
            }
        }

        const validationComment = (row['att_Validation Comment'] || '');
        const areasServed = (row['att_Areas Served'] || '');
        const commentLower = validationComment.toLowerCase();
        const areasServedLower = areasServed.toLowerCase();

        if (areasServedLower === 'other (list in comments)') {
            if (!commentLower.includes('serves ')) {
                errors.push({
                    field: 'att_Validation Comment',
                    value: validationComment,
                	reason: 'When Areas Served is "Other", the comment must contain the word "Serves" to describe what the asset serves.',
                    category: 'Missing Required Data'
                });
            }
        } else if (areasServed && commentLower.includes('serves ')) {
            const synonyms = areaServedSynonyms[areasServed] || [];
            const termsToCheck = [areasServedLower, ...synonyms];
            
            const isRedundant = termsToCheck.some(term => commentLower.includes(term));

            if (isRedundant) {
                errors.push({
                    field: 'att_Validation Comment',
                    value: validationComment,
                    reason: 'Redundant comment. The "Areas Served" field already specifies this. Use comments for additional details only.',
                    category: 'Formatting & Syntax Errors'
                });
            }
        }
        
        if (!assetNumber) errors.push({ field: 'att_Asset #', value: '(empty)', reason: 'Asset # is a required field.', category: 'Missing Required Data' });
        if (assetAcronym && !capacityExemptAcronyms.has(assetAcronym)) {
            const capacityQty = row['att_Capacity Quantity'];
            const capacityUnit = row['att_Capacity Unit'];
            if (!capacityQty || String(capacityQty).trim() === '') {
                errors.push({ field: 'att_Capacity Quantity', value: '(empty)', reason: 'Capacity Quantity is required for this asset type.', category: 'Missing Required Data' });
            }
            if (!capacityUnit || String(capacityUnit).trim() === '') {
                errors.push({ field: 'att_Capacity Unit', value: '(empty)', reason: 'Capacity Unit is required for this asset type.', category: 'Missing Required Data' });
            }
        }
        if (!isTagOnPM) {
            const inServiceDate = row['att_In-Service Date'];
            if (!inServiceDate || String(inServiceDate).trim() === '' || isNaN(new Date(inServiceDate).getTime())) {
                 errors.push({ field: 'att_In-Service Date', value: inServiceDate, reason: 'In-Service Date cannot be blank and must be a valid date.', category: 'Missing Required Data' });
            }
            const ngmCondition = row['att_NGM CA-Condition'];
            if (!ngmCondition || String(ngmCondition).trim() === '') {
                errors.push({ field: 'att_NGM CA-Condition', value: ngmCondition, reason: 'NGM CA-Condition cannot be blank.', category: 'Missing Required Data' });
            }
        }

		const condition = row['att_NGM CA-Condition'];
		const inServiceDateStr = row['att_In-Service Date'];
		const eul = assetEUL[assetAcronym];
		if (eul && condition && inServiceDateStr) {
			const inServiceDate = new Date(inServiceDateStr);
			if (!isNaN(inServiceDate.getTime())) {
				const now = new Date();
				const age = (now - inServiceDate) / (1000 * 60 * 60 * 24 * 365.25);
				if (age >= eul && (condition === 'Excellent' || condition === 'Good')) {
					errors.push({
						field: 'att_NGM CA-Condition',
						value: condition,
						reason: `Condition is unexpectedly high for an asset that is ${Math.round(age)} years old with a life expectancy of ${eul} years. Please verify.`,
						category: 'Miscellaneous Errors'
					});
				}
				if (age <= 2 && (condition === 'Poor' || condition === 'Failed')) {
					 errors.push({
						field: 'att_NGM CA-Condition',
						value: condition,
						reason: `Condition is unexpectedly low for an asset that is only ${age.toFixed(1)} years old. Please verify.`,
						category: 'Miscellaneous Errors'
					});
				}
			}
		}

        const spaceFloor = row['att_Space (Floor)'];
        const environment = row['Environment'];
        if (spaceFloor === 'Attic' && environment !== 'Wide variation in temp/humidity/dust') {
            errors.push({ field: 'Environment', value: environment, reason: 'For Attic space, Environment must be "Wide variation in temp/humidity/dust".', category: 'Miscellaneous Errors' });
        }
		if (spaceFloor === 'Mezzanine' && environment !== 'Wide variation in temp/humidity/dust') {
            errors.push({ field: 'Environment', value: environment, reason: 'For Mezzanine space, Environment must be "Wide variation in temp/humidity/dust".', category: 'Miscellaneous Errors' });
        }
        if (spaceFloor === 'Roof' && environment !== 'Extremes of temperature') {
            errors.push({ field: 'Environment', value: environment, reason: 'For Roof space, Environment must be "Extremes of temperature".', category: 'Miscellaneous Errors' });
        }
        if (spaceFloor === 'Building Exterior' && environment !== 'Extremes of temperature') {
            errors.push({ field: 'Environment', value: environment, reason: 'For Building Exterior space, Environment must be "Extremes of temperature".', category: 'Miscellaneous Errors' });
        }
		if (spaceFloor === 'Basement' && environment !== 'Liable to extreme dust or flooding') {
            errors.push({ field: 'Environment', value: environment, reason: 'For Basement space, Environment must be "Liable to extreme dust or flooding".', category: 'Miscellaneous Errors' });
        }
        
        const capacityQty = row['att_Capacity Quantity'];
        if (capacityQty && isNaN(parseFloat(capacityQty))) {
            errors.push({ field: 'att_Capacity Quantity', value: capacityQty, reason: 'Capacity Quantity must be a numerical value.', category: 'Formatting & Syntax Errors' });
        }

	    const refrigerantValue = (row['Refrigerant'] || '').trim();
        if (refrigerantValue) { 
            const upperCaseRefrigerantValue = refrigerantValue.toUpperCase();
            if (!refrigerantKeywordsSet.has(upperCaseRefrigerantValue)) {
                errors.push({ 
                    field: 'Refrigerant', 
                    value: refrigerantValue, 
                    reason: `Value '${refrigerantValue}' is not a recognized ASHRAE refrigerant.`, 
                    category: 'Formatting & Syntax Errors' 
                });
            }
        }

	    const upperCaseRefrigerant = (row['Refrigerant'] || '').trim().toUpperCase();
	    const dateRule = refrigerantDateRules[upperCaseRefrigerant];
	    if (dateRule && inServiceDateStr) {
		    const inServiceDate = new Date(inServiceDateStr);
		    if (!isNaN(inServiceDate.getTime())) {
			    if (inServiceDate > dateRule.phaseOutDate) {
				    errors.push({
					    field: 'Refrigerant / In-Service Date',
					    value: `${upperCaseRefrigerant} / ${inServiceDateStr}`,
					    reason: dateRule.reason(inServiceDateStr),
					    category: 'Miscellaneous Errors'
				    });
			    }
		    }
	    }

	    if ((row['Refrigerant'] || '').trim().toLowerCase() === 'other (list in comments)') {
		    const comment = (row['att_Validation Comment'] || '').toUpperCase();
		    const hasRefrigerantInComment = refrigerantKeywords.some(keyword => comment.includes(keyword.toUpperCase()));
		    if (!hasRefrigerantInComment) {
			    errors.push({
				    field: 'att_Validation Comment',
				    value: row['att_Validation Comment'],
				    reason: 'Refrigerant is "Other", but a valid ASHRAE refrigerant was not found in the comment.',
				    category: 'Missing Required Data'
			    });
		    }
	    }
	
        if (assetAcronym && !assetNumber.startsWith('TEMPLATE')) {
            if (!rule) {
                errors.push({ field: 'att_Asset #', value: assetAcronym, reason: `Unknown Acronym '${assetAcronym}'.`, category: 'Formatting & Syntax Errors' });
            } else {
                 if (rule.capacityUnit && rule.capacityUnit.length > 0) {
                     if (!rule.capacityUnit.includes(capacityUnit)) {
                         errors.push({ field: 'att_Capacity Unit', value: capacityUnit, reason: `Incorrect unit. Expected '${rule.capacityUnit.join(' or ')}' for '${assetDescription}'.`, category: 'Formatting & Syntax Errors' });
                     }
                 } else {
					if (capacityUnit !== '') {
						errors.push({
							field: 'att_Capacity Unit',
							value: capacityUnit,
							reason: `Capacity Unit must be blank for '${assetDescription}'.`,
							category: 'Formatting & Syntax Errors'
						});
					}
					if (capacityQty !== '') {
						errors.push({
							field: 'att_Capacity Quantity',
							value: capacityQty,
							reason: `Capacity Quantity must be blank when no unit is required.`,
							category: 'Formatting & Syntax Errors'
						});
					}
				}
            }
        }
        
        const comment = (row['att_Validation Comment'] || '').toLowerCase();
        
        if (assetAcronym === 'AHU' && !(row['Refrigerant'] || '').trim()) {
            if (!comment.includes('no cooling coil')) {
                 errors.push({ 
                    field: 'att_Validation Comment', 
                    value: row['att_Validation Comment'], 
                    reason: 'AHU has no refrigerant listed. Comment must state "No cooling coil." to confirm.', 
                    category: 'Missing Required Data' 
                });
            }
        }
        
        if (assetAcronym === 'F' || assetAcronym === 'EF') {
            const hasCoilAndRefrigerant = comment.includes('coil') && refrigerantKeywords.some(r => comment.toUpperCase().includes(r.toUpperCase()));
            const hasNoCoilMessage = comment.includes('no coil attached.');

            if (!hasCoilAndRefrigerant && !hasNoCoilMessage) {
                errors.push({ 
                    field: 'att_Validation Comment', 
                    value: row['att_Validation Comment'], 
                    reason: `${assetDescription} comment must either state "No coil attached." or mention "Coil" and a refrigerant type.`, 
                    category: 'Missing Required Data' 
                });
            }
        }

        if (!isTagOnPM && row['Refrigerant'] && refrigerantNotRequiredAssets.has(assetDescription)) {
            errors.push({ field: 'Refrigerant', value: row['Refrigerant'], reason: `Refrigerant not required for '${assetDescription}'.`, category: 'Miscellaneous Errors' });
        }
        
        const model = (row['att_Model'] || '').trim();
        if (model.includes(' ') && model !== 'No Nameplate Information Available') {
            errors.push({ field: 'att_Model', value: row['att_Model'], reason: 'Model number should not contain spaces.', category: 'Formatting & Syntax Errors' });
        }
        const serial = (row['att_Serial #'] || '').trim();
        if (serial.includes(' ') && serial !== 'No Nameplate Information Available') {
            errors.push({ field: 'att_Serial #', value: row['att_Serial #'], reason: 'Serial number should not contain spaces.', category: 'Formatting & Syntax Errors' });
        }

        const noNameplate = "No Nameplate Information Available";
        if (row['att_Manufacturer'] === noNameplate) {
            if (row['att_Model'] !== noNameplate) errors.push({ field: 'att_Model', value: row['att_Model'], reason: `Inconsistent Nameplate Data.`, category: 'Miscellaneous Errors' });
            if (row['att_Serial #'] !== noNameplate) errors.push({ field: 'att_Serial #', value: row['att_Serial #'], reason: `Inconsistent Nameplate Data.`, category: 'Miscellaneous Errors' });
        }

        const photoCount = [row['Image'], row['Image 2'], row['Image 3'], row['Image 4'], row['Image 5']].filter(Boolean).length;
        if (photoCount < 3) errors.push({ field: 'Images', value: `${photoCount} found`, reason: `Requires at least 3 photos.`, category: 'Missing Required Data' });

        if (buildingType === 'Meetinghouse' && welfareOnlyAcronyms.has(assetAcronym)) {
            errors.push({ field: 'att_Asset #', value: assetNumber, reason: `Asset type '${assetDescription}' should not be in a Meetinghouse.`, category: 'Miscellaneous Errors' });
        }

        if (assetNumber === 'FLC-1') {
            if (row['att_Room'] !== 'Building Interior') {
                errors.push({ 
                    field: 'att_Room', 
                    value: row['att_Room'], 
                    reason: 'For FLC-1, Room must be "Building Interior".', 
                    category: 'Miscellaneous Errors' 
                });
            }
            if (row['att_Areas Served'] !== 'Building Envelope') {
                errors.push({ 
                    field: 'att_Areas Served', 
                    value: row['att_Areas Served'], 
                    reason: 'For FLC-1, Areas Served must be "Building Envelope".', 
                    category: 'Miscellaneous Errors' 
                });
            }
        }
        if (row['att_Parent Asset Tag'] && !assetsRequiringParent.has(assetAcronym)) {
            errors.push({ 
                field: 'att_Parent Asset Tag', 
                value: row['att_Parent Asset Tag'], 
                reason: `This asset type ('${assetAcronym}') should not have a parent asset.`, 
                category: 'Miscellaneous Errors' 
            });
        }
        if (assetAcronym === 'DF') {
            const parentTag = row['att_Parent Asset Tag'] || '';
            if (!parentTag) {
                errors.push({ field: 'att_Parent Asset Tag', value: '(empty)', reason: 'Duct Furnace (DF) must have a parent asset.', category: 'Missing Required Data' });
            } else {
                const parentAsset = zoneData.find(asset => asset['TagID'] === parentTag);
                if (!parentAsset) {
                    errors.push({ field: 'att_Parent Asset Tag', value: parentTag, reason: `Parent asset with TagID '${parentTag}' not found in this work zone.`, category: 'Miscellaneous Errors' });
                } else {
                    const parentAcronym = getAcronym(parentAsset['att_Asset #']);
                    if (parentAcronym !== 'AHU') {
                        errors.push({ field: 'att_Parent Asset Tag', value: parentTag, reason: `Parent asset must be an Air Handling Unit (AHU), but found '${parentAcronym}'.`, category: 'Miscellaneous Errors' });
                    }
                }
            }
        }
        
        if (assetAcronym === 'FLB') {
            const parentTag = row['att_Parent Asset Tag'] || '';
            if (!parentTag) {
                errors.push({ field: 'att_Parent Asset Tag', value: '(empty)', reason: 'Forklift Battery (FLB) must have a parent asset.', category: 'Missing Required Data' });
            } else {
                const parentAsset = zoneData.find(asset => asset['TagID'] === parentTag);
                if (!parentAsset) {
                    errors.push({ field: 'att_Parent Asset Tag', value: parentTag, reason: `Parent asset with TagID '${parentTag}' not found in this work zone.`, category: 'Miscellaneous Errors' });
                } else {
                    const parentAcronym = getAcronym(parentAsset['att_Asset #']);
                    if (parentAcronym !== 'FRK') {
                        errors.push({ field: 'att_Parent Asset Tag', value: parentTag, reason: `Parent asset must be a Forklift (FRK), but found '${parentAcronym}'.`, category: 'Miscellaneous Errors' });
                    }
                }
            }
        }
        if (assetAcronym === 'FRK') {
            const capacityUnit = row['att_Capacity Unit'] || '';
            const validationComment = (row['att_Validation Comment'] || '').toLowerCase();
            
            if (capacityUnit === 'Other (List In Comments)') {
                if (!validationComment.includes('pounds') && !validationComment.includes('lbs')) {
                    errors.push({
                        field: 'att_Validation Comment',
                        value: row['att_Validation Comment'],
                        reason: 'Capacity is "Other". The comment must specify the capacity in pounds or LBS.',
                        category: 'Missing Required Data'
                    });
                }
            }
        }
        return errors;
    }

    function analyzeWorkZoneData(data, buildingType) {
        let zoneResults = {
            errors: [],
            systemStatus: {},
            indoorCount: 0,
            outdoorCount: 0,
            primarySurveyors: 'N/A',
			notFoundAssets: []
        };

        const assetNumbers = new Set();
        const foundDuplicates = new Set();
        const modelStats = new Map();
        data.forEach(row => {
			const isNotFoundPlaceholder = (row['Reason Not Tagged'] || '').trim() === 'Not Found' && !row['TagID'];
        	if (isNotFoundPlaceholder) {
            	zoneResults.notFoundAssets.push(row['att_Asset #'] || 'Unknown Asset');
        	}
            const model = (row['att_Model'] || '').trim();
            if (model && model !== 'No Nameplate Information Available') {
                if (!modelStats.has(model)) modelStats.set(model, new Map());
                
                const variationKey = JSON.stringify({
                    manufacturer: row['att_Manufacturer'],
                    capacity: row['att_Capacity Quantity'],
                    refrigerant: row['Refrigerant']
                });
                const stats = modelStats.get(model);
                stats.set(variationKey, (stats.get(variationKey) || 0) + 1);
            }
        });
        const modelRules = new Map();
        for (const [model, stats] of modelStats.entries()) {
            if (stats.size > 1) {
                let majorityKey = null, maxCount = 0;
                for (const [key, count] of stats.entries()) {
                    if (count > maxCount) {
                        maxCount = count;
                        majorityKey = key;
                    }
                }
                if (majorityKey) modelRules.set(model, JSON.parse(majorityKey));
            }
        }
        data.forEach(row => {
            const assetNum = row['att_Asset #'];
            const acronym = getAcronym(assetNum);
            if (assetNum) {
                if (assetNumbers.has(assetNum) && !foundDuplicates.has(assetNum)) {
                    zoneResults.errors.push({ assetNum, reason: `Duplicate Asset # '${assetNum}' found in this work zone.`, category: 'Formatting & Syntax Errors' });
                    foundDuplicates.add(assetNum);
                }
                assetNumbers.add(assetNum);
            }
        if (splitSystemOutdoor.has(acronym)) {
            zoneResults.outdoorCount++;
        } else if (splitSystemIndoor.has(acronym)) {
            let isSelfContained = false;
            if (acronym === 'AHU') {
                const description = (row['att_Asset Description'] || '').toLowerCase();
                isSelfContained = Array.from(selfContainedAHUKeywords).some(keyword => description.includes(keyword));
            }
            if (!isSelfContained) {
                zoneResults.indoorCount++;
            }
        }
            const model = row['att_Model'];
            const rule = modelRules.get(model);
            if (rule) {
                const isConsistent = rule.manufacturer === row['att_Manufacturer'] &&
                                     rule.capacity === row['att_Capacity Quantity'] &&
                                     rule.refrigerant === row['Refrigerant'];
                if (!isConsistent) {
                    const expected = `Man: ${rule.manufacturer}, Cap: ${rule.capacity}, Ref: ${rule.refrigerant || 'N/A'}`;
					const actual = `Man: ${row['att_Manufacturer']}, Cap: ${row['att_Capacity Quantity']}, Ref: ${row['Refrigerant'] || 'N/A'}`;
                    zoneResults.errors.push({
                        assetNum: row['att_Asset #'],
                        reason: `Inconsistent data for model '${model}'. Majority expects: ${expected}. Actual: ${actual}.`,
                        category: 'Miscellaneous Errors'
                    });
                }
            }
        });
        const requiredSystems = buildingType === 'Meetinghouse' 
            ? requiredMeetinghouseAcronyms 
            : buildingType === 'Welfare' 
            ? requiredWelfareAcronyms 
            : null;
        if (requiredSystems) {
            const foundAcronyms = new Set(data.map(a => getAcronym(a['att_Asset #'])));
            const notFoundAssets = new Set(data.filter(a => (a['Reason Not Tagged'] || '').trim() === 'Not Found').map(a => getAcronym(a['att_Asset #'])));
        for (const systemName in requiredSystems) {
            const acronyms = Array.isArray(requiredSystems[systemName]) ? requiredSystems[systemName] : [requiredSystems[systemName]];
            let isFound = false;
            const isDocumentedNotFound = acronyms.some(a => notFoundAssets.has(a));

            if (systemName.startsWith('Flooring')) {
                const requiredArea = systemName.includes('Building Envelope') ? 'Building Envelope' : 'Cultural Center';
                isFound = data.some(row => 
                    acronyms.includes(getAcronym(row['att_Asset #'])) &&
                    row['att_Areas Served'] === requiredArea &&
                    (row['Reason Not Tagged'] || '').trim() !== 'Not Found'
                );
            } else {
                isFound = acronyms.some(a => foundAcronyms.has(a));
            }

            if (isFound && !isDocumentedNotFound) {
                zoneResults.systemStatus[systemName] = 'Found';
            } else if (isDocumentedNotFound) {
                zoneResults.systemStatus[systemName] = 'Not Found';
            } else {
                zoneResults.systemStatus[systemName] = 'Missing';
                zoneResults.errors.push({
                    assetNum: 'Work Zone-wide',
                    reason: `Required system '${systemName}' is missing from the work zone.`,
                    category: 'System Verifications',
                    field: 'System Verification'
                });
            }
        }
        }
        const surveyorCounts = data.reduce((acc, row) => {
            const creator = row['Created by'];
            if (creator) acc[creator] = (acc[creator] || 0) + 1;
            return acc;
        }, {});
        if (Object.keys(surveyorCounts).length) {
            zoneResults.primarySurveyors = Object.keys(surveyorCounts).join(', ');
        }
	    const hvacMatch = zoneResults.indoorCount === zoneResults.outdoorCount;
	    if (!hvacMatch) {
	        zoneResults.errors.push({
	            assetNum: 'Work Zone-wide',
	            reason: `HVAC split system count mismatch. Indoor: ${zoneResults.indoorCount}, Outdoor: ${zoneResults.outdoorCount}.`,
	            category: 'System Verifications',
	            field: 'HVAC Count'
	        });
	    }
		
        return zoneResults;
    }
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('csvFile');
    const fileNameDisplay = document.getElementById('file-name');
    const validateBtn = document.getElementById('validate-btn');
    const buildingTypeSelect = document.getElementById('buildingType');
    const preValidationStep = document.getElementById('pre-validation-step');
    const downloadCsvBtn = document.getElementById('download-csv-btn');
    const downloadSummaryBtn = document.getElementById('download-summary-btn');
    let allReportsData = {};
    fileInput.addEventListener('change', handleFileSelect);
    buildingTypeSelect.addEventListener('change', () => {
        validateBtn.disabled = !fileInput.files.length || !buildingTypeSelect.value;
    });
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults, false));
    ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('drag-over'), false));
    ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('drag-over'), false));
    dropZone.addEventListener('drop', handleDrop, false);
    validateBtn.addEventListener('click', validateData);
	document.getElementById('report-content').addEventListener('click', function(event) {
    if (event.target.classList.contains('copy-table-btn')) {
        copyTableToClipboard(event);
	    }
	});
    downloadCsvBtn.addEventListener('click', downloadCSV);
    downloadSummaryBtn.addEventListener('click', downloadSummaryCSV);
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    function handleDrop(e) { handleFiles(e.dataTransfer.files); }
    function handleFileSelect(e) { handleFiles(e.target.files); }
    function handleFiles(files) {
        if (files.length > 0) {
            fileInput.files = files;
            fileNameDisplay.textContent = files[0].name;
            preValidationStep.style.display = 'block';
            validateBtn.disabled = !buildingTypeSelect.value;
        }
    }
	function analyzeGlobalInconsistencies(allData) {
	    const modelStats = new Map();
	
	    
	    allData.forEach(row => {
	        const model = (row['att_Model'] || '').trim()
	        
	        if (model && model !== 'No Nameplate Information Available') {
	            if (!modelStats.has(model)) {
	                modelStats.set(model, new Map());
	            }
	
	            const acronym = getAcronym(row['att_Asset #']);
	            const variationKey = JSON.stringify({
	                type: acronym,
	                manufacturer: (row['att_Manufacturer'] || '').trim(),
	                capacity: row['att_Capacity Quantity'],
	                refrigerant: row['Refrigerant']
	            });
	
	            const stats = modelStats.get(model);
	            stats.set(variationKey, (stats.get(variationKey) || 0) + 1);
	        }
	    });
	
	    const modelRules = new Map();
	    for (const [model, stats] of modelStats.entries()) {
	        if (stats.size > 1) {
	            let majorityVariationKey = null;
	            let maxCount = 0;
	            for (const [variationKey, count] of stats.entries()) {
	                if (count > maxCount) {
	                    maxCount = count;
	                    majorityVariationKey = variationKey;
	                }
	            }
	            if (majorityVariationKey) {
	                modelRules.set(model, JSON.parse(majorityVariationKey));
	            }
	        }
	    }
	
	    const globalErrors = [];
	    allData.forEach((row, index) => {
	        const model = row['att_Model'];
	        const rule = modelRules.get(model);
	
	        if (rule) {
	            const acronym = getAcronym(row['att_Asset #']);
	            const isConsistent = rule.type === acronym &&
	                                 rule.manufacturer === (row['att_Manufacturer'] || '').trim() &&
	                                 rule.capacity === row['att_Capacity Quantity'] &&
	                                 rule.refrigerant === row['Refrigerant'];
	            
	            if (!isConsistent) {
	                const expected = `Type: ${rule.type}, Man: ${rule.manufacturer}, Cap: ${rule.capacity}, Ref: ${rule.refrigerant || 'N/A'}`;
	                const actual = `Type: ${acronym}, Man: ${(row['att_Manufacturer'] || '').trim()}, Cap: ${row['att_Capacity Quantity']}, Ref: ${row['Refrigerant'] || 'N/A'}`;
	                globalErrors.push({
	                    rowNum: index + 2,
	                    assetNum: row['att_Asset #'],
	                    workZone: row['WORK ZONE'],
	                    field: 'Global Model Inconsistency',
	                    value: `Model: ${model}`,
	                    reason: `Data is inconsistent with the majority. Expected: ${expected}. Actual: ${actual}.`,
	                    category: 'Global Model Inconsistencies',
	                    ninoxId: row['Ninox ID']
	                });
	            }
	        }
	    });
	    return globalErrors;
	}
    function validateData() {
        if (!fileInput.files.length || !buildingTypeSelect.value) {
            console.error('Please select a file and a building type.');
            return;
        }
        validateBtn.disabled = true;
        validateBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Validating...`;
		Papa.parse(fileInput.files[0], {
			header: true,
			skipEmptyLines: true,
			complete: function(results) {
				const data = results.data;
				const buildingType = buildingTypeSelect.value;
                let templateRowErrors = false;
				const globalErrors = analyzeGlobalInconsistencies(data);
				const workZoneGroups = data.reduce((acc, row) => {
                    const workZone = row['WORK ZONE'] || 'Unknown Work Zone';
                    if (!acc[workZone]) {
                        acc[workZone] = [];
                    }
                    acc[workZone].push(row);
                    return acc;
				}, {});
				allReportsData = {};
				for (const workZone in workZoneGroups) {
					const zoneData = workZoneGroups[workZone];
					let allErrors = [];
					const zoneAnalysis = analyzeWorkZoneData(zoneData, buildingType);
					zoneAnalysis.errors.forEach(err => allErrors.push({ ...err, rowNum: 'Work Zone-wide', assetNum: err.assetNum, workZone: workZone, ninoxId: 'N/A' }));
                        zoneData.forEach((row, index) => {
                            const rowErrors = validateRow(row, buildingType, zoneData);
                            if (rowErrors.length > 0) {
                                allErrors.push(...rowErrors.map(err => ({ ...err, rowNum: index + 2, assetNum: row['att_Asset #'], workZone: workZone, ninoxId: row['Ninox ID'] })));
                                if (rowErrors.some(err => err.category === 'Template Rows to Delete')) {
                                    templateRowErrors = true;
                                }
                            }
                        });
                        
                        allReportsData[workZone] = {
                            data: zoneData,
                            errors: allErrors,
                            analysis: zoneAnalysis,
                            templateRowErrors: templateRowErrors
                        };
                }
				if (globalErrors.length > 0) {
                    allReportsData['global'] = {
                        data: [], 
                        errors: globalErrors,
                        analysis: null, 
                        templateRowErrors: false
                    };
                }
                updateResultsUI(allReportsData);
                validateBtn.disabled = false;
                validateBtn.innerHTML = 'Run Internal Audit';
            },
            error: function(err) {
                console.error('Error parsing CSV file:', err);
                validateBtn.disabled = false;
                validateBtn.innerHTML = 'Run Internal Audit';
            }
        });
    }

    function updateResultsUI(allReports) {
        const reportContent = document.getElementById('report-content');
        reportContent.innerHTML = '';
        if (allReports['global']) {
            const globalReport = allReports['global'];
            const details = document.createElement('details');
            details.className = 'bg-white rounded-lg shadow-md border border-red-300 mb-6';
            details.open = true;

            const summary = document.createElement('summary');
            summary.className = 'p-4 cursor-pointer font-bold text-lg text-red-700 flex justify-between items-center';
            summary.innerHTML = `<span>Global Model Inconsistencies (${globalReport.errors.length} found)</span><svg class="w-5 h-5 details-marker" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
            
            const globalReportContainer = document.createElement('div');
            globalReportContainer.className = 'p-6 border-t';
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container overflow-x-auto';
            
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-slate-200';
            table.innerHTML = `
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Work Zone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ninox ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Asset #</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Row</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Invalid Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Reason for Error</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200"></tbody>
            `;
            
            const errorBody = table.querySelector('tbody');
            globalReport.errors.forEach(error => {
                const tr = errorBody.insertRow();
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${error.workZone || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${error.ninoxId || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${error.assetNum || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${error.rowNum}</td>
                    <td class="px-6 py-4 text-sm text-slate-700"><div class="truncate max-w-xs" title="${String(error.value || '')}">${String(error.value || 'N/A')}</div></td>
                    <td class="px-6 py-4 text-sm text-red-600">${error.reason}</td>
                `;
            });

            tableContainer.appendChild(table);
            globalReportContainer.appendChild(tableContainer);
            details.appendChild(summary);
            details.appendChild(globalReportContainer);
            reportContent.appendChild(details);
        }
        for (const workZone in allReports) {
			if (workZone === 'global') continue;
            const report = allReports[workZone];
            const { data, errors, analysis, templateRowErrors } = report;
            const details = document.createElement('details');
            details.className = 'bg-white rounded-lg shadow-inner border border-slate-200';
            details.open = true;
            const summary = document.createElement('summary');
            summary.className = 'p-4 cursor-pointer font-bold text-lg text-slate-800 flex justify-between items-center';
            summary.innerHTML = `<span>Work Zone: ${workZone}</span><svg class="w-5 h-5 details-marker" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
            const zoneReportContainer = document.createElement('div');
            zoneReportContainer.className = 'p-6 border-t';
            let reportHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Error Summary</h3>
                        <div class="space-y-3 error-summary-list"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">System Verifications</h3>
                        <div class="space-y-3 system-verifications-list"></div>
                    </div>
                </div>
                <div class="p-6 border-t mt-6">
						<div class="flex justify-between items-center mb-4">
						    <h3 class="text-lg font-semibold text-slate-800">Error Details</h3>
						    <button class="copy-table-btn bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded text-xs hover:bg-gray-300">
						        Copy Table
						    </button>
						</div>
                        <div class="table-container overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200 error-table">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ninox ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Asset #</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Row</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Field with Error</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Invalid Value</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Reason for Error/Rule Violated</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-200 error-body"></tbody>
                            </table>
                        </div>
                        <div class="py-10 text-center text-green-600 font-semibold no-errors-message" style="display:none;">
                            <svg class="w-16 h-16 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            All assets in this work zone are valid. No issues found!
                        </div>
                </div>
            `;
            zoneReportContainer.innerHTML = reportHTML;
            const errorBody = zoneReportContainer.querySelector('.error-body');
            const errorSummaryList = zoneReportContainer.querySelector('.error-summary-list');
            const systemVerificationsList = zoneReportContainer.querySelector('.system-verifications-list');
            const errorTable = zoneReportContainer.querySelector('.error-table');
            const noErrorsMessage = zoneReportContainer.querySelector('.no-errors-message');
            const errorCounts = { 'Review Required': 0, 'Formatting & Syntax Errors': 0, 'Missing Required Data': 0, 'Miscellaneous Errors': 0 };
            errors.forEach(err => {
                if (err.category !== 'Template Rows to Delete') {
                    if (errorCounts[err.category] !== undefined) errorCounts[err.category]++;
                    else errorCounts['Miscellaneous Errors']++;
                }
            });
            const templateRows = data.filter(r => r.TagID === 'DELETE' || r['att_Asset #']?.startsWith('TEMPLATE'));
            let templateLabel = "Template Rows to Delete";
            if (templateRows.length > 0) {
                templateLabel = templateRowErrors ? "Template Rows to Mark for Deletion" : "Template Rows Marked for Deletion";
            }
            errorCounts[templateLabel] = templateRows.length;
            for (const category in errorCounts) {
                if (category === 'Template Rows to Delete' && errorCounts[category] === 0) continue;
                errorSummaryList.innerHTML += `<div class="flex justify-between items-center text-sm"><p class="text-slate-600">${category}</p><span class="font-bold text-slate-800 bg-slate-200 rounded-full px-2 py-0.5">${errorCounts[category]}</span></div>`;
            }
			for (const systemName in analysis.systemStatus) {
                let statusText;
                let statusColor;
                if (analysis.systemStatus[systemName] === 'Found') {
                    statusText = '✅ Found';
                    statusColor = 'text-green-600';
                } else if (analysis.systemStatus[systemName] === 'Not Found') {
                    statusText = '⚠️ Documented Not Found';
                    statusColor = 'text-amber-600';
                } else {
                    statusText = '❌ Missing';
                    statusColor = 'text-red-600 font-bold';
                }
                systemVerificationsList.innerHTML += `<div class="flex justify-between items-center text-sm"><p class="text-slate-600">${systemName}</p><span class="font-semibold ${statusColor}">${statusText}</span></div>`;
            }
				if (analysis.notFoundAssets && analysis.notFoundAssets.length > 0) {
                const notFoundSection = document.createElement('div');
                notFoundSection.className = 'mt-8';

                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-slate-800 mb-4';
                title.textContent = 'Documented "Not Found" Assets';
                notFoundSection.appendChild(title);

                const listContainer = document.createElement('div');
                listContainer.className = 'bg-slate-50 border border-slate-200 rounded-md p-4';
                
                const listHTML = analysis.notFoundAssets.map(assetNum => 
                    `<li class="text-sm text-slate-700">${assetNum}</li>`
                ).join('');

                listContainer.innerHTML = `<ul class="list-disc list-inside space-y-1">${listHTML}</ul>`;
                notFoundSection.appendChild(listContainer);
                
                const errorDetailsContainer = zoneReportContainer.querySelector('.p-6.border-t.mt-6');
                zoneReportContainer.insertBefore(notFoundSection, errorDetailsContainer);
            }
            systemVerificationsList.innerHTML += `<div class="flex justify-between items-center text-sm"><p class="text-slate-600">Primary Surveyor(s)</p><span class="font-semibold text-slate-800">${analysis.primarySurveyors}</span></div>`;
            const hvacMatch = analysis.indoorCount === analysis.outdoorCount;
            systemVerificationsList.innerHTML += `<div class="flex justify-between items-center text-sm"><p class="text-slate-600">HVAC Split System Counts</p><span class="font-semibold ${hvacMatch ? 'text-green-600' : 'text-red-600'}">Indoor: ${analysis.indoorCount} – Outdoor: ${analysis.outdoorCount} ${hvacMatch ? '✅' : '❌'}</span></div>`;
            if (!hvacMatch) {
                systemVerificationsList.innerHTML += `<div class="text-xs text-amber-700 pl-2 mt-1">- Recommendation: Verify Indoor/Outdoor HVAC matching configuration in this work zone.</div>`;
            }
            if (errors.length > 0) {
                errors.forEach(error => {
                    const tr = errorBody.insertRow();
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${error.ninoxId || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${error.assetNum || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${error.rowNum}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-800">${error.field || 'Work Zone-wide'}</td>
                        <td class="px-6 py-4 text-sm text-slate-700"><div class="truncate max-w-xs" title="${String(error.value || '')}">${String(error.value || 'N/A')}</div></td>
                        <td class="px-6 py-4 text-sm text-red-600">${error.reason}</td>
                    `;
                });
                errorTable.style.display = 'table';
                noErrorsMessage.style.display = 'none';
            } else {
                errorTable.style.display = 'none';
                noErrorsMessage.style.display = 'block';
            }
            details.appendChild(summary);
            details.appendChild(zoneReportContainer);
            reportContent.appendChild(details);
        }
        document.getElementById('results-container').style.display = 'block';
        downloadCsvBtn.style.display = 'block';
        downloadSummaryBtn.style.display = 'block';
    }

    function downloadCSV() {
        try {
            const originalFileName = fileInput.files[0] ? fileInput.files[0].name.replace('.csv', '') : 'Asset_Report';
            let allErrorsForCSV = [];
	        for (const workZone in allReportsData) {
	            const report = allReportsData[workZone];
	            report.errors.forEach(error => { 
	                allErrorsForCSV.push({
	                    "Work Zone": workZone,
	                    "Ninox ID": error.ninoxId || 'N/A',
	                    "Asset #": error.assetNum || 'N/A',
	                    "Error Category": error.category,
	                    "Row #": error.rowNum,
	                    "Field with Error": error.field || 'Work Zone-wide',
	                    "Invalid Value": String(error.value || 'N/A'),
	                    "Reason for Error": error.reason
	                });
	            });
	        }
            if (allErrorsForCSV.length === 0) {
                console.log("No errors to report!");
                return;
            }
            const csv = Papa.unparse(allErrorsForCSV);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${originalFileName}_Error_Report.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("Error generating CSV:", error);
        }
    }

    function downloadSummaryCSV() {
        try {
            const originalFileName = fileInput.files[0] ? fileInput.files[0].name.replace('.csv', '') : 'Asset_Report';
            let summaryData = [];
            for (const workZone in allReportsData) {
                const report = allReportsData[workZone];
                const errorCounts = { 'Review Required': 0, 'Formatting & Syntax Errors': 0, 'Missing Required Data': 0, 'Miscellaneous Errors': 0 };
                let templateCount = 0;
                report.errors.forEach(err => {
                    if (err.category === 'Template Rows to Delete') {
                        templateCount++;
                    } else if (errorCounts[err.category] !== undefined) {
                        errorCounts[err.category]++;
                    } else {
                        errorCounts['Miscellaneous Errors']++;
                    }
                });
                for (const category in errorCounts) {
                    if (errorCounts[category] > 0) {
                        summaryData.push({
                            "Work Zone": workZone,
                            "Error Category": category,
                            "Count": errorCounts[category]
                        });
                    }
                }
                if (templateCount > 0) {
                    summaryData.push({
                        "Work Zone": workZone,
                        "Error Category": "Template Rows to Delete",
                        "Count": templateCount
                    });
                }
            }
            if (summaryData.length === 0) {
                console.log("No errors to summarize!");
                return;
            }
            const csv = Papa.unparse(summaryData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${originalFileName}_Summary_Report.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("Error generating Summary CSV:", error);
        }
    }
	function copyTableToClipboard(event) {
	    const button = event.target;
	    const table = button.closest('.p-6').querySelector('.error-table');
	    if (!table) return;
	
	    let data = [];
	    const headers = [];
	    table.querySelectorAll('thead th').forEach(header => headers.push(header.innerText));
	    data.push(headers.join('\t'));
	
	    table.querySelectorAll('tbody tr').forEach(row => {
	        const rowData = [];
	        row.querySelectorAll('td').forEach(cell => {
	            rowData.push(cell.innerText.trim());
	        });
	        data.push(rowData.join('\t'));
	    });
	
	    navigator.clipboard.writeText(data.join('\n')).then(() => {
	        const originalText = button.innerHTML;
	        button.innerHTML = 'Copied!';
	        button.disabled = true;
	        setTimeout(() => {
	            button.innerHTML = originalText;
	            button.disabled = false;
	        }, 2000);
	    }).catch(err => {
	        console.error('Failed to copy table: ', err);
	        alert('Could not copy the table. Please check the browser console for errors.');
	    });
	}
});
</script>

</body>
</html>

